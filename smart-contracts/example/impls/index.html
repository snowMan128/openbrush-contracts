<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">Lending impls | OpenBrush</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.openbrush.io/smart-contracts/example/impls"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Lending impls | OpenBrush"><meta data-react-helmet="true" name="description" content="The lending contract implementation consists of two traits:"><meta data-react-helmet="true" property="og:description" content="The lending contract implementation consists of two traits:"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.openbrush.io/smart-contracts/example/impls"><link data-react-helmet="true" rel="alternate" href="https://docs.openbrush.io/smart-contracts/example/impls" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.openbrush.io/smart-contracts/example/impls" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3900dd10.css">
<link rel="preload" href="/assets/js/runtime~main.15477289.js" as="script">
<link rel="preload" href="/assets/js/main.405a70f8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenBrush" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-dark.svg" alt="OpenBrush" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/smart-contracts/overview">Examples</a><a class="navbar__item navbar__link" href="/deployment">Deploy</a><a href="https://twitter.com/supercolony_net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link"></a><a href="https://github.com/Supercolony-net/openbrush-contracts" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle toggle_2i4l react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/">Getting started</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Smart Contracts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/access-control">Access Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/ownable">Ownable</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/reentrancy-guard">Reentrancy Guard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/pausable">Pausable</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/payment-splitter">Payment Splitter</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/timelock-controller">Timelock Controller</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP22</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP22/psp22">PSP22</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Utils</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP34</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP34/psp34">PSP34</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP1155</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP1155/psp1155">PSP1155</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">OpenBrush Example</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/setup_project">Setup the project</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/psp22">Implement PSP-22 contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/shares">Shares contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/loan">Loan contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/data">Data and derive macro</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/smart-contracts/example/impls">Lending impls</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/errors">Errors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/contract">Lending contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/implementation">Notes about methods</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/deployment">Deploy</a></li><li class="menu__list-item"><a class="menu__link" href="/evm-wasm-smart-contracts">EVM vs WASM Smart Contracts</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1>Lending impls</h1></header><p>The lending contract implementation consists of two traits:</p><ul><li><code>Lending</code> - contains methods that can be called by anyone.
These methods can be used to lend, borrow, liquidate assets and get some information about them.</li><li><code>LendingPermissioned</code> - contains methods with restrictions. These methods can be called by a manager.
These methods allow defining the list of allowed tokens, setting price and etc.</li></ul><p>We will define everything stuff from the previous chapter for &quot;inheritable&quot; contracts:</p><ul><li>Both traits in <code>traits/lending.rs</code></li><li>A data structure and <code>LendingStorage</code> storage trait in <code>impls/lending/data.rs</code></li><li>A derive macro for <code>LendingStorage</code> in <code>derive/lib.rs</code></li><li>A generic implementation for trait <code>Lending</code> in <code>impls/lending/lending.rs</code></li><li>A generic implementation for trait <code>LendingPermissioned</code> in <code>impls/lending/lending_permissioned.rs</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="definition-of-traits"></a>Definition of traits<a class="hash-link" href="#definition-of-traits" title="Direct link to heading">#</a></h2><p>In the <code>traits/lending.rs</code>, we will define <code>Lending</code> and <code>LendingPermissioned</code> traits.
We plan that <code>LendingContract</code> also will implement <code>AccessControl</code> and <code>Pausable</code>, so
<code>LendingContractRef</code> is defined like a combination of <code>AccessControl</code>, <code>Pausable</code>, <code>LendingPermissioned</code> and <code>Lending</code>.
That wrapper describes all methods available in the <code>LendingContract</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">use brush::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  contracts::traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    access_control::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pausable::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    psp22::PSP22Error,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    psp34::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      PSP34Error,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// Combination of all traits of the contract to simplify calls to the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::wrapper]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub type LendingContractRef = dyn Lending + LendingPermissioned + AccessControl + Pausable;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::wrapper]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub type LendingRef = dyn Lending;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::trait_definition]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub trait Lending {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will return the total amount of assets available to borrow</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// along with amount of the same asset borrowed</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AssetNotSupported` error if we try to get amount of asset not supported by our contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn total_asset(&amp;self, asset_address: AccountId) -&gt; Result&lt;Balance, LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will return the total amount of shares minted for an asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AssetNotSupported` error if we try to get shares of asset not supported by our contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn total_shares(&amp;self, asset_address: AccountId) -&gt; Result&lt;Balance, LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will return true if the asset is accepted by the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn is_accepted_lending(&amp;self, asset_address: AccountId) -&gt; bool;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will return true if the asset is accepted by the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn is_accepted_collateral(&amp;self, asset_address: AccountId) -&gt; bool;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function is called by a user who wants to lend tokens and gain interest</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `asset_address` is the AccountId of the PSP-22 token to be deposited</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `amount` is the amount to be deposited</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientAllowanceToLend` if the caller does not have enough allowance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientBalanceToLend` if the caller does not have enough balance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AssetNotSupported` if the asset is not supported for lending</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn lend_assets(&amp;mut self, asset_address: AccountId, amount: Balance) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function is called by a user who wants to borrow tokens. In order to do that,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// they need to deposit collateral. The value of borrowed assets will be equal to 70%</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// of the value of deposited collateral.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `asset_address` is the AccountId of the PSP-22 token to be borrowed</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `collateral_address` is the AccountId of the PSP-22 token used as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `amount` is the amount to be deposited</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AssetNotSupported` if `asset_address` is not supported for using as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientAllowanceForCollateral` if the caller does not have enough allowance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientCollateralBalance` if the caller does not have enough balance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AssetNotSupported` if the borrowing asset is not supported for borrowing</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `AmountNotSupported` if the liquidation price is less than or equal to the borrowed amount</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientBalanceInContract` if there is not enough amount of assets in the contract to borrow</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn borrow_assets(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    collateral_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function is called by the user who borrowed some asset. User needs to deposit borrowed amount along with interest</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// They can either repay the full amount or just a portion of the amount. If they repay the full amount, they will get all deposited</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// collateral back, another way they will get back the same portion of collateral as the repay portion (eg. if they deposit 80% of</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// the loan + interests, they will get 80% of collateral back). If the loan was liquidated, the user does not get their collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// back and the NFT will be burned</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `loan_id` is the id of the loan to be repaid</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `repay_amount` is the amount of borrowed asset to be repaid</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns true if the loan was repaid successfuly, false if the loan was already liquidated and can not be repaid</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `NotTheOwner` error if the initiator is not the owner of the loan token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientAllowanceToRepay` error if the initiator did not give allowance to the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientBalanceToRepay` error if the initiator tries to repay more tokens than their balance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn repay(&amp;mut self, loan_id: Id, repay_amount: Balance) -&gt; Result&lt;bool, LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function is called by the user who wants to withdraw assets they deposited for lending. They will deposit their</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// share tokens and get back their share of the asset mapped to this share token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `shares_address` account id of the shares token which is binded to the asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `shares_amount` amount of shares being withdrawn</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `InsufficientBalanceInContract` if there is currently not enough assets in the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn withdraw_asset(&amp;mut self, shares_address: AccountId, shares_amount: Balance) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will liquidate the loan with `loan_id`. In this example contract the tokens will be kept in the smart</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// contract and the liquidator gets 1% of the liquidated assets. In a real implementation we would swap the collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// for the borrowed asset so we would be able to cover the shares of lenders.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// `loan_id` id of loan to be liquidated</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ///</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `LoanLiquidated` error if the loan was already liquidated</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// Returns `CanNotBeLiquidated` error if the price of collateral is not below the liquidation price</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn liquidate_loan(&amp;mut self, loan_id: Id) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::wrapper]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub type LendingPermissionedRef = dyn LendingPermissioned;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::trait_definition]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub trait LendingPermissioned {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will allow an asset to be accepted by the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// It will also create the contracts for the shares token and lended reserves token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message, payable)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn allow_asset(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will disallow lending and borrowing of asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// To do this all assets of this asset must be repaid and all of the asset must be withdrawn</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn disallow_lending(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will allow an asset to be accepted as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn allow_collateral(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will disallow an asset to be accepted as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn disallow_collateral(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// This function will set price of `asset_in` in `asset_out` to `amount` in our simulated oracle</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn set_asset_price(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_in: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_out: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    price: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ) -&gt; Result&lt;(), LendingError&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="data-and-storage-trait"></a>Data and storage trait<a class="hash-link" href="#data-and-storage-trait" title="Direct link to heading">#</a></h2><p>In the <code>impls/lending/data.rs</code> we will define the data related to the lending contract.
After, we will define a storage trait via <code>declare_storage_trait!</code> macro to return a
<code>LendingData</code> and define some helper functions. </p><p>In this example we will not be using price oracles, we will do
our own simulated oracle. Since oracles are not the point of this example,
it will be enough for us. We will store prices info in our data struct.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">// importing everything publicly from traits allows you to import every stuff related to lending</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">// by one import</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub use crate::traits::lending::*;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use brush::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    declare_storage_trait,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AccountIdExt,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Hash,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ZERO_ADDRESS,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use ink_storage::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Mapping,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    traits::SpreadLayout,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">// it is public because when you will import the trait you also will import the derive for the trait</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub use lending_project_derive::LendingStorage;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[cfg(feature = &quot;std&quot;)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use ink_storage::traits::StorageLayout;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[derive(Default, Debug, SpreadLayout)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[cfg_attr(feature = &quot;std&quot;, derive(StorageLayout))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// define the struct with the data that our smart contract will be using</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// this will isolate the logic of our smart contract from its storage</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub struct LendingData {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from asset address to lended asset address</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// when X amount of asset is lended, X amount of asset it is mapped to is minted</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// so the contract knows how much of asset it has and how much of the asset was lended</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub assets_lended: Mapping&lt;AccountId, AccountId&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from asset address to shares asset address</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// the lended asset is mapped to a shares asset which represents</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// the total share of the mapping asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// example: if a user has X% of the total supply of the asset A&#x27;, they</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// are eligible to withdraw X% of the asset A tracked by this contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub asset_shares: Mapping&lt;AccountId, AccountId&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from share token to asset token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub shares_asset: Mapping&lt;AccountId, AccountId&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from asset address to bool</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// maps to `true` if an asset is accepted for using as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub collateral_accepted: Mapping&lt;AccountId, bool&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from tuple of two assets to balance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapped balance represents the amount of assets of tuple.1 we get</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// when we deposit 1 unit of tuple.0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// we are using this just to simulate an oracle in our example</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// in the example the returned balance will be amount of stable coin for an asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub asset_price: Mapping&lt;(AccountId, AccountId), Balance&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// code hash of the `SharesContract`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub shares_contract_code_hash: Hash,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// the `AccountId` of the `Loan`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub loan_account: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">declare_storage_trait!(LendingStorage, LendingData);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// this internal function will be used to set price of `asset_in` when we deposit `asset_out`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// we are using this function in our example to simulate an oracle</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub fn set_asset_price&lt;T: LendingStorage&gt;(instance: &amp;mut T, asset_in: AccountId, asset_out: AccountId, price: Balance) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    instance.get_mut().asset_price.insert((&amp;asset_in, &amp;asset_out), &amp;price);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// this internal function will be used to set price of `asset_in` when we deposit `asset_out`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// we are using this function in our example to simulate an oracle</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub fn get_asset_price&lt;T: LendingStorage&gt;(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    instance: &amp;T,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount_in: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_in: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_out: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">) -&gt; Balance {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let price = instance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .asset_price</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get((&amp;asset_in, &amp;asset_out))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .unwrap_or(0);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    price * amount_in</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// Internal function which will return the address of the shares token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// which are minted when `asset_address` is borrowed</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub fn get_reserve_asset&lt;T: LendingStorage&gt;(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    instance: &amp;T,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_address: &amp;AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">) -&gt; Result&lt;AccountId, LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let reserve_asset = instance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .asset_shares</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get(asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .unwrap_or(ZERO_ADDRESS.into());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if reserve_asset.is_zero() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        return Err(LendingError::AssetNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(reserve_asset)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// internal function which will return the address of asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// which is bound to `shares_address` shares token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub fn get_asset_from_shares&lt;T: LendingStorage&gt;(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    instance: &amp;T,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    shares_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">) -&gt; Result&lt;AccountId, LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let token = instance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .shares_asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .get(&amp;shares_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .unwrap_or(ZERO_ADDRESS.into());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if token.is_zero() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        return Err(LendingError::AssetNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(token)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Derive macro for <code>LendingStorage</code> is created by the <a href="/smart-contracts/example/data#macros-from-openbrush">description</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="a-generic-implementation-of-lendingpermissioned-trait"></a>A generic implementation of <code>LendingPermissioned</code> trait<a class="hash-link" href="#a-generic-implementation-of-lendingpermissioned-trait" title="Direct link to heading">#</a></h2><p>The all methods in <code>LendingPermissioned</code> are restricted and requires <code>#[modifiers(only_role(MANAGER))]</code>.
That means that only accounts with <code>MANAGER</code> role can execute these methods.
Usage of <code>only_role</code> modifier from <a href="https://github.com/Supercolony-net/openbrush-contracts/blob/main/contracts/access/access_control/mod.rs#L30" target="_blank" rel="noopener noreferrer">access_control</a>
requires that the contract should implement <code>AccessControlStorage</code>.
For that we also require the same restriction on the generic type.</p><p>In the implementation of <code>LendingPermissioned</code>, we want to use methods from
<code>Lending</code>. For that, the set of restrictions for generic in the <code>Lending</code> implementation
should be a subset(&lt;=) of restrictions for generic in the <code>LendingPermissioned</code> implementation.
The <code>Lending</code> implementation requires <code>LendingStorage</code> and <code>PausableStorage</code> to use <code>when_paused</code>
modifier from <a href="https://github.com/Supercolony-net/openbrush-contracts/blob/main/contracts/security/pausable/mod.rs#L24" target="_blank" rel="noopener noreferrer">pausable</a>.
So we should have the same restriction in our generic implementation.</p><p>In the logic of the trait <code>LendingPermissioned</code> we need to instantiate
the <code>SharesContract</code>. But we can&#x27;t import <code>SharesContract</code> into <code>lending_project</code>
crate, because <code>SharesContract</code> also depends on <code>lending_project</code>.
That will cause cyclic dependencies.
To avoid that we will import <code>SharesContract</code> into <code>LendingContract</code> and in <code>LendingContract</code> we will define
<code>_instantiate_shares_contract</code> method, that will instantiate <code>SharesCotnract</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl LendingPermissionedInternal for LendingContract {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn _instantiate_shares_contract(&amp;self, contract_name: &amp;str, contract_symbol: &amp;str) -&gt; AccountId {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let code_hash = self.lending.shares_contract_code_hash;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let (hash, _) =</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            ink_env::random::&lt;ink_env::DefaultEnvironment&gt;(contract_name.as_bytes()).expect(&quot;Failed to get salt&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let hash = hash.as_ref();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let contract = SharesContract::new(Some(String::from(contract_name)), Some(String::from(contract_symbol)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .endowment(0)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .code_hash(code_hash)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .salt_bytes(&amp;hash[..4])</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .instantiate()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .unwrap();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    contract.to_account_id()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For that we defined the <code>LendingPermissionedInternal</code> trait with <code>_instantiate_shares_contract</code> method.</p><p>The final generic implementation of the <code>LendingPermissioned</code> restricts the generic type <code>T</code>
by <code>LendingStorage</code>, <code>AccessControlStorage</code>, <code>PausableStorage</code>, <code>LendingPermissionedInternal</code> traits.
That allows us to use methods from these traits and define the implementation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub use super::data::*;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use brush::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  contracts::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    access_control::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pausable::PausableStorage,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    traits::psp22::PSP22Ref,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  modifiers,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ZERO_ADDRESS,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub const MANAGER: RoleType = ink_lang::selector_id!(&quot;MANAGER&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl&lt;T: LendingStorage + PausableStorage + LendingPermissionedInternal + AccessControlStorage&gt; LendingPermissioned</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">for T</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[modifiers(only_role(MANAGER))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  default fn allow_asset(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // we will ensure the asset is not accepted already</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if self.is_accepted_lending(asset_address) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      return Err(LendingError::AssetSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // instantiate the shares of the lended assets</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let shares_address = self._instantiate_shares_contract(&quot;LendingShares&quot;, &quot;LS&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // instantiate the reserves of the borrowed assets</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let reserves_address = self._instantiate_shares_contract(&quot;LendingReserves&quot;, &quot;LR&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // accept the asset and map shares and reserves to it</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    accept_lending(self, asset_address, shares_address, reserves_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[modifiers(only_role(MANAGER))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  default fn disallow_lending(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    let reserve_asset = get_reserve_asset(self, &amp;asset_address)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if PSP22Ref::balance_of(&amp;asset_address, Self::env().account_id()) &gt; 0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            || PSP22Ref::balance_of(&amp;reserve_asset, Self::env().account_id()) &gt; 0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      return Err(LendingError::AssetsInTheContract)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    disallow_lending(self, asset_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[modifiers(only_role(MANAGER))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  default fn allow_collateral(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // we will ensure the asset is not accepted already</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if self.is_accepted_collateral(asset_address) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      return Err(LendingError::AssetSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    set_collateral_accepted(self, asset_address, true);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[modifiers(only_role(MANAGER))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  default fn disallow_collateral(&amp;mut self, asset_address: AccountId) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // we will ensure the asset is not accepted already</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    if self.is_accepted_collateral(asset_address) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      set_collateral_accepted(self, asset_address, false);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  #[modifiers(only_role(MANAGER))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  default fn set_asset_price(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_in: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    asset_out: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    price: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    set_asset_price(self, asset_in, asset_out, price);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub trait LendingPermissionedInternal {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /// internal function which instantiates a shares contract and returns its AccountId</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  fn _instantiate_shares_contract(&amp;self, contract_name: &amp;str, contract_symbol: &amp;str) -&gt; AccountId;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">fn accept_lending&lt;T: LendingStorage&gt;(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance: &amp;mut T,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  asset_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  share_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  reserve_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().asset_shares.insert(&amp;asset_address, &amp;share_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().shares_asset.insert(&amp;share_address, &amp;asset_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().assets_lended.insert(&amp;asset_address, &amp;reserve_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">fn disallow_lending&lt;T: LendingStorage&gt;(instance: &amp;mut T, asset_address: AccountId) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  let share_address = instance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          .get_mut()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          .asset_shares</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          .get(&amp;asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          .unwrap_or(ZERO_ADDRESS.into());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().asset_shares.take(&amp;asset_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().shares_asset.take(&amp;share_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().assets_lended.take(&amp;asset_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// this function will accept `asset_address` for using as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">fn set_collateral_accepted&lt;T: LendingStorage&gt;(instance: &amp;mut T, asset_address: AccountId, accepted: bool) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  instance.get_mut().collateral_accepted.insert(&amp;asset_address, &amp;accepted);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="a-generic-implementation-of-lending-trait"></a>A generic implementation of <code>Lending</code> trait<a class="hash-link" href="#a-generic-implementation-of-lending-trait" title="Direct link to heading">#</a></h2><p>The same logic is used during definition of the implementation for <code>Lending</code> trait.</p><p>The <code>PausableStorage</code> restriction is required to use <code>when_paused</code>, <code>when_not_paused</code> modifiers
from <a href="https://github.com/Supercolony-net/openbrush-contracts/blob/main/contracts/security/pausable/mod.rs#L24" target="_blank" rel="noopener noreferrer">pausable</a>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">// importing everything publicly from traits allows you to import every stuff related to lending</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">// by one import</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub use super::data::*;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub use crate::traits::lending::*;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use crate::traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    loan::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        LoanInfo,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        LoanRef,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    shares::SharesRef,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use brush::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    contracts::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        pausable::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            psp22::PSP22Ref,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            psp34::Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    modifiers,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AccountIdExt,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ZERO_ADDRESS,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use ink_prelude::vec::Vec;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub const YEAR: Timestamp = 60 * 60 * 24 * 365;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl&lt;T: LendingStorage + PausableStorage&gt; Lending for T {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn total_asset(&amp;self, asset_address: AccountId) -&gt; Result&lt;Balance, LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // get asset from mapping</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mapped_asset = LendingStorage::get(self)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .assets_lended</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .get(&amp;asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .unwrap_or(ZERO_ADDRESS.into());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // return error if the asset is not supported</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if mapped_asset.is_zero() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::AssetNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let contract = Self::env().account_id();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let available = PSP22Ref::balance_of(&amp;asset_address, contract);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let unavailable = PSP22Ref::balance_of(&amp;mapped_asset, contract);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(available + unavailable)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn total_shares(&amp;self, asset_address: AccountId) -&gt; Result&lt;Balance, LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // get asset from mapping</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mapped_asset = LendingStorage::get(self)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .asset_shares</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .get(&amp;asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .unwrap_or(ZERO_ADDRESS.into());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // return error if the asset is not supported</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if mapped_asset.is_zero() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::AssetNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(PSP22Ref::total_supply(&amp;mapped_asset))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn is_accepted_lending(&amp;self, asset_address: AccountId) -&gt; bool {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        !LendingStorage::get(self)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .asset_shares</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .get(&amp;asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .unwrap_or(ZERO_ADDRESS.into())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .is_zero()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn is_accepted_collateral(&amp;self, asset_address: AccountId) -&gt; bool {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        LendingStorage::get(self)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .collateral_accepted</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .get(&amp;asset_address)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .cloned()</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            .unwrap_or(false)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(when_not_paused)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn lend_assets(&amp;mut self, asset_address: AccountId, amount: Balance) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // we will be using these often so we store them in variables</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let lender = Self::env().caller();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let contract = Self::env().account_id();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure the user gave allowance to the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::allowance(&amp;asset_address, lender, contract) &lt; amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientAllowanceToLend)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure the user has enough assets</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::balance_of(&amp;asset_address, lender) &lt; amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientBalanceToLend)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // how much assets is already in the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // if the asset is not accepted by the contract, this function will return an error</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let total_asset = self.total_asset(asset_address)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // transfer the assets from user to the contract|</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        PSP22Ref::transfer_from(&amp;asset_address, lender, contract, amount, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // if no assets were deposited yet we will mint the same amount of shares as deposited `amount`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let new_shares = if total_asset == 0 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            amount</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            // else we calculate how much shares will belong us after depositing the `amount`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            (amount * self.total_shares(asset_address)?) / total_asset</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let reserve_asset = get_reserve_asset(self, &amp;asset_address)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // mint the shares token to the user</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        SharesRef::mint(&amp;reserve_asset, lender, new_shares)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(when_not_paused)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn borrow_assets(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        asset_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        collateral_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // we will be using these often so we store them in variables</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let borrower = Self::env().caller();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let contract = Self::env().account_id();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure this asset is accepted as collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if !self.is_accepted_collateral(collateral_address) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::AssetNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure the user gave allowance to the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::allowance(&amp;collateral_address, borrower, contract) &lt; amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientAllowanceForCollateral)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure the user has enough collateral assets</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::balance_of(&amp;collateral_address, borrower) &lt; amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientCollateralBalance)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let reserve_asset = get_reserve_asset(self, &amp;asset_address)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // we will find out the price of deposited collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let price = get_asset_price(self, amount, collateral_address, asset_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // we will set the liquidation price to be 75% of current price</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let liquidation_price = (price * 75) / 100;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // borrow amount is 70% of collateral</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let borrow_amount = (price * 70) / 100;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure the liquidation price is greater than borrowed amount to avoid misuses</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if borrow_amount &gt;= liquidation_price {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::AmountNotSupported)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure we have enough assets in the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::balance_of(&amp;asset_address, contract) &lt; borrow_amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientBalanceInContract)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // we will transfer the collateral to the contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        PSP22Ref::transfer_from(&amp;collateral_address, borrower, contract, amount, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // create loan info</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = LoanInfo {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            borrower,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            collateral_token: collateral_address,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            collateral_amount: amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            borrow_token: asset_address,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            borrow_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            liquidation_price,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            timestamp: Self::env().block_timestamp(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            liquidated: false,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let load_account = LendingStorage::get(self).loan_account;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        LoanRef::create_loan(&amp;load_account, loan_info)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // transfer assets to borrower</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        PSP22Ref::transfer(&amp;asset_address, borrower, borrow_amount, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // mint `borrow_amount` of the reserve token</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        SharesRef::mint(&amp;reserve_asset, contract, borrow_amount)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn repay(&amp;mut self, loan_id: Id, repay_amount: Balance) -&gt; Result&lt;bool, LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // REPAYING (borrower: B, nft, repayAmount: X):</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let initiator = Self::env().caller();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let contract = Self::env().account_id();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_account = LendingStorage::get(self).loan_account;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let apy = 1000;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // initiator must own the nft</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if LoanRef::owner_of(&amp;loan_account, loan_id).unwrap_or(ZERO_ADDRESS.into()) != initiator {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::NotTheOwner)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = LoanRef::get_loan_info(&amp;loan_account, loan_id)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if loan_info.liquidated {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            LoanRef::delete_loan(&amp;loan_account, initiator, loan_id)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Ok(false)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure initiator has enough allowance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::allowance(&amp;loan_info.borrow_token, initiator, contract) &lt; repay_amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientAllowanceToRepay)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // ensure initiator has enough balance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if PSP22Ref::balance_of(&amp;loan_info.borrow_token, initiator) &lt; repay_amount {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientBalanceToRepay)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let time_passed = Self::env().block_timestamp() - loan_info.timestamp;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let total_apy = (apy * time_passed as Balance) / YEAR as Balance;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let to_repay = (((loan_info.borrow_amount) * (10000 + total_apy)) / 10000) + 1;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let reserve_asset = get_reserve_asset(self, &amp;loan_info.borrow_token)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if repay_amount &gt;= to_repay {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            PSP22Ref::transfer_from(&amp;loan_info.borrow_token, initiator, contract, to_repay, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            PSP22Ref::transfer(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &amp;loan_info.collateral_token,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                initiator,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                loan_info.collateral_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                Vec::&lt;u8&gt;::new(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            )?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            LoanRef::delete_loan(&amp;loan_account, initiator, loan_id)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            SharesRef::burn(&amp;reserve_asset, loan_info.borrow_amount)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            PSP22Ref::transfer_from(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &amp;loan_info.borrow_token,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                initiator,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                contract,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                repay_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                Vec::&lt;u8&gt;::new(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            )?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            let to_return = (repay_amount * loan_info.collateral_amount) / to_repay;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            PSP22Ref::transfer(&amp;loan_info.collateral_token, initiator, to_return, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            SharesRef::mint(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &amp;reserve_asset,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                contract,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                to_repay - repay_amount - loan_info.borrow_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            )?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            LoanRef::update_loan(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &amp;loan_account,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                loan_id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                to_repay - repay_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                Self::env().block_timestamp(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                loan_info.collateral_amount - to_return,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            )?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(true)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn withdraw_asset(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        shares_address: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        shares_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let withdraw_asset = get_asset_from_shares(self, shares_address)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let withdraw_amount =</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            (shares_amount * self.total_asset(withdraw_asset)?) / PSP22Ref::total_supply(&amp;shares_address);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if withdraw_amount &gt; PSP22Ref::balance_of(&amp;withdraw_asset, Self::env().account_id()) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::InsufficientBalanceInContract)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        SharesRef::burn_from(&amp;shares_address, Self::env().caller(), shares_amount)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        PSP22Ref::transfer(&amp;withdraw_asset, Self::env().caller(), withdraw_amount, Vec::&lt;u8&gt;::new())?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    default fn liquidate_loan(&amp;mut self, loan_id: Id) -&gt; Result&lt;(), LendingError&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_account = LendingStorage::get(self).loan_account;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = LoanRef::get_loan_info(&amp;loan_account, loan_id)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if loan_info.liquidated {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::LoanLiquidated)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let price = get_asset_price(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            loan_info.collateral_amount,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            loan_info.collateral_token,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            loan_info.borrow_token,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        );</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if price &lt;= loan_info.liquidation_price {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            // if we swapped the collateral to borrow asset we would burn the reserve tokens</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            // let reserve_asset = self._get_reserve_asset(borrow_asset);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            // PSP22BurnableRef::burn(&amp;reserve_asset, borrow_amount)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            let reward = (loan_info.collateral_amount * 1000) / 100000;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            PSP22Ref::transfer(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &amp;loan_info.collateral_token,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                Self::env().caller(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                reward,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                Vec::&lt;u8&gt;::new(),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            )?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            LoanRef::liquidate_loan(&amp;loan_account, loan_id)?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(LendingError::CanNotBeLiquidated)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/Supercolony-net/openbrush-contracts/tree/main/docs/docs/smart-contracts/example/impls.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/smart-contracts/example/data"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Data and derive macro</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/smart-contracts/example/errors"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Errors Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#definition-of-traits" class="table-of-contents__link">Definition of traits</a></li><li><a href="#data-and-storage-trait" class="table-of-contents__link">Data and storage trait</a></li><li><a href="#a-generic-implementation-of-lendingpermissioned-trait" class="table-of-contents__link">A generic implementation of <code>LendingPermissioned</code> trait</a></li><li><a href="#a-generic-implementation-of-lending-trait" class="table-of-contents__link">A generic implementation of <code>Lending</code> trait</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 OpenBrush, Supercolony.net.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.15477289.js"></script>
<script src="/assets/js/main.405a70f8.js"></script>
</body>
</html>