<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">Loan contract | OpenBrush</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.openbrush.io/smart-contracts/example/loan"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Loan contract | OpenBrush"><meta data-react-helmet="true" name="description" content="In our project we will also implement PSP-721"><meta data-react-helmet="true" property="og:description" content="In our project we will also implement PSP-721"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.openbrush.io/smart-contracts/example/loan"><link data-react-helmet="true" rel="alternate" href="https://docs.openbrush.io/smart-contracts/example/loan" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.openbrush.io/smart-contracts/example/loan" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3900dd10.css">
<link rel="preload" href="/assets/js/runtime~main.93062ece.js" as="script">
<link rel="preload" href="/assets/js/main.5df6b7cd.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenBrush" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-dark.svg" alt="OpenBrush" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/smart-contracts/overview">Examples</a><a class="navbar__item navbar__link" href="/deployment">Deploy</a><a href="https://twitter.com/supercolony_net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link"></a><a href="https://github.com/Supercolony-net/openbrush-contracts" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle toggle_2i4l react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/">Getting started</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Smart Contracts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/access-control">Access Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/ownable">Ownable</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/reentrancy-guard">Reentrancy Guard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/pausable">Pausable</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/payment-splitter">Payment Splitter</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/timelock-controller">Timelock Controller</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP22</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP22/psp22">PSP22</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Utils</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP721</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP721/psp721">PSP721</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PSP1155</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/PSP1155/psp1155">PSP1155</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Extensions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">OpenBrush Example</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/setup_project">Setup the project</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/psp22">Implement PSP-22 contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/shares">Shares contract</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/smart-contracts/example/loan">Loan contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/data">Data and derive macro</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/impls">Lending impls</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/errors">Errors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/contract">Lending contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/smart-contracts/example/implementation">Notes about methods</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/deployment">Deploy</a></li><li class="menu__list-item"><a class="menu__link" href="/evm-wasm-smart-contracts">EVM vs WASM Smart Contracts</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1>Loan contract</h1></header><p>In our project we will also implement <a href="/smart-contracts/PSP721/psp721">PSP-721</a>
token. This token will represent a loan of a user who borrowed some assets.
Upon borrowing assets the contract will mint an NFT to them, which will hold
the information about their loan, namely the user who borrowed the assets,
address of the asset which was used as collateral, how much collateral was
deposited, what asset was borrowed, and how much, the liquidation price of
the loan, timestamp of when was the loan performed, and information whether
the loan is liquidated or not. This data will be stored in a separate storage
trait, which we will derive in our NFT contract. We do this to separate storage
from the logic, and we will do this in the lending contract as well.
We do not want anybody to just mint and burn these, so we will implement
the <a href="/smart-contracts/ownable">Ownable</a> extension in our NFT. The mint and burn
logic will be covered differently, we will not be using the mintable and
burnable extensions.</p><p>The <code>LoanContract</code> will contain several methods defined in the <code>Loan</code> trait.
These methods are restricted and can be called only by an owner of the contract.
There is not too much logic to split it, so everything will be implemented
in the body of the contract.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="definition-of-the-loan-trait"></a>Definition of the <code>Loan</code> trait<a class="hash-link" href="#definition-of-the-loan-trait" title="Direct link to heading">#</a></h2><p>In the <code>traits/loan.rs</code>, we will define a <code>Loan</code> trait.
That trait contains three super traits: <code>PSP721</code>, <code>PSP721Metadata</code>, and <code>Ownable</code>.
Also, the trait contains several methods, and the definition of the <code>LoanInfo</code>
(that structure is used during interacting with the contract
so it is defined in the <code>traits</code> instead of the body of the contract).
<code>LoanRef</code> can be used by other developers to do a cross contract call to <code>LoanContract</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">use brush::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    contracts::traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ownable::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        psp721::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            extensions::metadata::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            *,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use ink_storage::traits::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PackedLayout,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SpreadLayout,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[cfg(feature = &quot;std&quot;)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">use ink_storage::traits::StorageLayout;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[derive(Default, Debug, Clone, scale::Encode, scale::Decode, SpreadLayout, PackedLayout)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[cfg_attr(feature = &quot;std&quot;, derive(StorageLayout, scale_info::TypeInfo))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub struct LoanInfo {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub borrower: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub collateral_token: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub collateral_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub borrow_token: AccountId,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub borrow_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub liquidation_price: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub timestamp: Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub liquidated: bool,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::wrapper]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub type LoanRef = dyn Loan + PSP721 + PSP721Metadata + Ownable;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::trait_definition]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub trait Loan: PSP721 + PSP721Metadata + Ownable {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// This function initalizes data of a loan and mint token inside it</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn create_loan(&amp;mut self, loan_info: LoanInfo) -&gt; Result&lt;(), PSP721Error&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// This function frees data of a loan and burn token inside it</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn delete_loan(&amp;mut self, initiator: AccountId, loan_id: Id) -&gt; Result&lt;(), PSP721Error&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// This function will be used when the user repays their loan only partially</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn update_loan(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_id: Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_borrow_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_timestamp: Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_collateral_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ) -&gt; Result&lt;(), PSP721Error&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// This function will set a loan to liquidated</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn liquidate_loan(&amp;mut self, loan_id: Id) -&gt; Result&lt;(), PSP721Error&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// Function returns `LoanInfo` by `Id`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn get_loan_info(&amp;self, loan_id: Id) -&gt; Result&lt;LoanInfo, PSP721Error&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="add-dependencies"></a>Add dependencies<a class="hash-link" href="#add-dependencies" title="Direct link to heading">#</a></h2><p>In addition to the dependencies imported in the <a href="/smart-contracts/PSP721/psp721">PSP-721</a>
documentation, we will also add the <code>ownable</code> dependency the same way as in the
<a href="/smart-contracts/ownable">ownable</a> documentation. We will be using <code>LoanContract</code>
as a dependency in our lending contract to instantiate it. So we need to also add
the <code>&quot;rlib&quot;</code> crate type to have the ability to import the <code>LoanContract</code> as a dependency.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="implement-the-contract"></a>Implement the contract<a class="hash-link" href="#implement-the-contract" title="Direct link to heading">#</a></h2><p>We want a basic <a href="/smart-contracts/PSP721/psp721">PSP-721</a> token with metadata and ownable extensions,
so we will add these to our contract. We will add a <code>brush::contract</code> macro to our contract and add some imports:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">#![cfg_attr(not(feature = &quot;std&quot;), no_std)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#![feature(min_specialization)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// This contract will represent the loan of a user</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[brush::contract]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub mod loan {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    use brush::contracts::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ownable::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        psp721::extensions::metadata::*,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[cfg(not(feature = &quot;ink-as-dependency&quot;))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    use brush::modifiers;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[cfg(not(feature = &quot;ink-as-dependency&quot;))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    use ink_prelude::{</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        string::String,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        vec::Vec,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[cfg(not(feature = &quot;ink-as-dependency&quot;))]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    use ink_storage::collections::HashMap as StorageHashMap;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    use lending_project::traits::loan::*;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You can notice that we marked some imports with <code>#[cfg(not(feature = &quot;ink-as-dependency&quot;))]</code>.
It is needed to remove rust&#x27;s warnings when we will import <code>LoanContract</code> as <code>ink-as-dependency</code>
into <code>LendingContract</code> for instantiation. When we are importing some contracts as
<code>ink-as-dependency</code>, we only import the signature of methods without
the implementation of them. It is why the imports are not used during
<code>ink-as-dependency</code> and it is why Rust is throwing warnings.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="define-the-storage"></a>Define the storage<a class="hash-link" href="#define-the-storage" title="Direct link to heading">#</a></h2><p>We will derive the storage traits related to <code>PSP-721</code>, <code>PSP-721 Metadata</code>, and
<code>Ownable</code> and declare the fields related to these traits. Also, we will declare
fields related to <code>Loan</code> itself.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// Define the storage for PSP721 data, Metadata data and Ownable data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[ink(storage)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#[derive(Default, PSP721Storage, OwnableStorage, PSP721MetadataStorage)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pub struct LoanContract {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[PSP721StorageField]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    psp721: PSP721Data,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[OwnableStorageField]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ownable: OwnableData,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[PSP721MetadataStorageField]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    metadata: PSP721MetadataData,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    // Fields of current contract</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// mapping from token id to `LoanInfo`</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    loan_info: StorageHashMap&lt;Id, LoanInfo&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// the id of last loan</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    last_loan_id: Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// ids no longer used (can be reused)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    freed_ids: Vec&lt;Id&gt;,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="implement-the-extension-traits"></a>Implement the extension traits<a class="hash-link" href="#implement-the-extension-traits" title="Direct link to heading">#</a></h2><p>We will be using these extensions in our NFT token, so we will implement them for our storage.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// implement PSP721 Trait for our NFT</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl PSP721 for LoanContract {}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// implement Ownable Trait for our NFT</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl Ownable for LoanContract {}</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/// implement PSP721Metadata Trait for our NFT</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl PSP721Metadata for LoanContract {}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="implement-the-loan-trait"></a>Implement the Loan trait<a class="hash-link" href="#implement-the-loan-trait" title="Direct link to heading">#</a></h2><p>We will implement the <code>Loan</code> trait.
All functions except one are restricted by the <code>only_owner</code> modifier.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl Loan for LoanContract {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(only_owner)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn create_loan(&amp;mut self, mut loan_info: LoanInfo) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_id = self._get_next_loan_id_and_increase()?;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if self.loan_info.get(&amp;loan_id).is_some() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(PSP721Error::Custom(String::from(&quot;This loan id already exists!&quot;)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_info.liquidated = false;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self.loan_info.insert(loan_id, loan_info.clone());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self._mint_to(loan_info.borrower, loan_id)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(only_owner)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn delete_loan(&amp;mut self, initiator: AccountId, loan_id: Id) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self.loan_info.take(&amp;loan_id);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self._burn_from(initiator, loan_id)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(only_owner)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn update_loan(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_id: Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_borrow_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_timestamp: Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_collateral_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self._update_loan(loan_id, new_borrow_amount, new_timestamp, new_collateral_amount)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[modifiers(only_owner)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn liquidate_loan(&amp;mut self, loan_id: Id) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self._liquidate_loan(loan_id)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(message)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn get_loan_info(&amp;self, loan_id: Id) -&gt; Result&lt;LoanInfo, PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = self.loan_info.get(&amp;loan_id);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if loan_info.is_none() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(PSP721Error::Custom(String::from(&quot;Loan does not exist&quot;)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(loan_info.cloned().unwrap())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="define-the-constructor-and-add-functions"></a>Define the constructor and add functions<a class="hash-link" href="#define-the-constructor-and-add-functions" title="Direct link to heading">#</a></h2><p>Finally, we will define the constructor where we will set the name and
the symbol of the token and then initialize the owner of the token
(that owner will be able to mint and burn the tokens).
We will also add several helper functions.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#9CDCFE"><span class="token plain">impl LoanContract {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// constructor with name and symbol</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #[ink(constructor)]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pub fn new() -&gt; Self {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mut instance = Self::default();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        instance._init_with_metadata(Some(String::from(&quot;LoanContract NFT&quot;)), Some(String::from(&quot;L-NFT&quot;)));</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        instance._init_with_owner(Self::env().caller());</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        instance</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// internal function to update data of a loan</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn _update_loan(</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &amp;mut self,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_id: Id,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_borrow_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_timestamp: Timestamp,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_collateral_amount: Balance,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = self.loan_info.get(&amp;loan_id);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if loan_info.is_none() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(PSP721Error::Custom(String::from(&quot;This loan does not exist!&quot;)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mut loan_info = loan_info.cloned().unwrap();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_info.collateral_amount = new_collateral_amount;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_info.borrow_amount = new_borrow_amount;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_info.timestamp = new_timestamp;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self.loan_info.insert(loan_id, loan_info);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// internal function to set loan to liquidated</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn _liquidate_loan(&amp;mut self, loan_id: Id) -&gt; Result&lt;(), PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let loan_info = self.loan_info.get(&amp;loan_id);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if loan_info.is_none() {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Err(PSP721Error::Custom(String::from(&quot;This loan does not exist!&quot;)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mut loan_info = loan_info.cloned().unwrap();</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        loan_info.liquidated = true;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self.loan_info.insert(loan_id, loan_info);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /// internal function to return the id of a new loan and to increase it in the storage</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fn _get_next_loan_id_and_increase(&amp;mut self) -&gt; Result&lt;Id, PSP721Error&gt; {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        if self.freed_ids.len() &gt; 0 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            return Ok(self.freed_ids.pop().unwrap())</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        let mut current = self.last_loan_id;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        // It is not fully correct implementation of the increasing. but it is only an example</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        for n in 0..32 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            if current[n] == u8::MAX {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                if n == 31 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    return Err(PSP721Error::Custom(String::from(&quot;Max Id reached!&quot;)))</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    current[n] = 0;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                current[n] += 1;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                break</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self.last_loan_id = current;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Ok(current)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/Supercolony-net/openbrush-contracts/tree/main/docs/docs/smart-contracts/example/loan.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/smart-contracts/example/shares"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Shares contract</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/smart-contracts/example/data"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Data and derive macro Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#definition-of-the-loan-trait" class="table-of-contents__link">Definition of the <code>Loan</code> trait</a></li><li><a href="#add-dependencies" class="table-of-contents__link">Add dependencies</a></li><li><a href="#implement-the-contract" class="table-of-contents__link">Implement the contract</a></li><li><a href="#define-the-storage" class="table-of-contents__link">Define the storage</a></li><li><a href="#implement-the-extension-traits" class="table-of-contents__link">Implement the extension traits</a></li><li><a href="#implement-the-loan-trait" class="table-of-contents__link">Implement the Loan trait</a></li><li><a href="#define-the-constructor-and-add-functions" class="table-of-contents__link">Define the constructor and add functions</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 OpenBrush, Supercolony.net.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.93062ece.js"></script>
<script src="/assets/js/main.5df6b7cd.js"></script>
</body>
</html>